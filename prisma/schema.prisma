// Prisma schema
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          String    @default("user")
  accounts      Account[]
  sessions      Session[]
  orders        Order[]
  cart          Cart?
  addresses     Address[]
  favorites     Favorite[]
  reviews       Review[]
  totalSpent    Int       @default(0)
  isBanned      Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  label     String?  // Címke (pl. Otthon, Munkahely)
  street    String
  city      String
  zipCode   String
  country   String   @default("Magyarország")
  phoneNumber String?
  taxNumber String?  // Adószám (cégeknek)
  isDefault Boolean  @default(false) // Alapértelmezett szállítási cím
  isBillingDefault Boolean @default(false) // Alapértelmezett számlázási cím
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, productId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String
  price       Int
  salePrice       Int?
  salePercentage  Float?
  saleStartDate   DateTime?
  saleEndDate     DateTime?
  stock       Int      @default(10)
  category    String
  image       String
  images      String[] @default([])
  rating      Float    @default(0)
  fullDescription String?
  specifications Json?
  isArchived Boolean  @default(false)
  
  brandId     String?
  brand       Brand?   @relation(fields: [brandId], references: [id])

  options    ProductOption[]
  variants   ProductVariant[]
  reviews    Review[]
  orderItems OrderItem[]
  favoritedBy Favorite[]
  cartItems  CartItem[]
  coupons    Coupon[]
  inventoryLogs InventoryLog[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([category])
  @@index([price])
  @@index([rating])
  @@index([createdAt])
  @@index([name])
  @@index([brandId])
}

model SpecificationTemplate {
  id        String   @id @default(cuid())
  name      String
  fields    Json     // Changed from String[] to Json to support types (text, boolean, header)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Order {
  id              String      @id @default(cuid())
  customerName    String
  customerEmail   String
  customerAddress String
  billingAddress  String?
  billingName     String?
  taxNumber       String?
  customerPhone   String?
  totalPrice      Int
  status          String      @default("pending")
  paymentMethod   String      @default("cod") // "cod", "stripe", "transfer"
  userId          String?
  user            User?       @relation(fields: [userId], references: [id])
  items           OrderItem[]
  createdAt       DateTime    @default(now())
  couponCode      String?
  discountAmount  Int         @default(0)
  loyaltyDiscount Int         @default(0)
  invoiceUrl      String?
  notes           OrderNote[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model OrderNote {
  id        String   @id @default(cuid())
  content   String
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  author    String
  createdAt DateTime @default(now())
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  productId Int?
  product   Product? @relation(fields: [productId], references: [id])
  variantId String?
  name      String?  // Snapshot of product name at time of purchase
  quantity  Int
  price     Int
  selectedOptions Json?
}

model ProductOption {
  id        String   @id @default(cuid())
  name      String
  values    String[]
  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model ProductVariant {
  id        String   @id @default(cuid())
  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  attributes Json
  price     Int
  salePrice       Int?
  salePercentage  Float?
  saleStartDate   DateTime?
  saleEndDate     DateTime?
  stock     Int
  isActive  Boolean  @default(true)
  sku       String?
  images    String[] @default([])
  description String?
  cartItems   CartItem[]
  inventoryLogs InventoryLog[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Attribute {
  id        String   @id @default(cuid())
  name      String   @unique
  values    String[]
}

model Review {
  id        String   @id @default(cuid())
  userName  String
  rating    Int
  text      String
  status    String   @default("pending") // "pending", "approved", "rejected"
  createdAt DateTime @default(now())

  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId Int
  
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
}

model Coupon {
  id            String    @id @default(cuid())
  code          String    @unique
  discountType  String    // "PERCENTAGE" or "FIXED"
  discountValue Float
  isActive      Boolean   @default(true)
  expiresAt     DateTime?
  usageLimit    Int?
  usedCount     Int       @default(0)
  minOrderValue Int?      @default(0)
  categoryId    String?
  category      Category? @relation(fields: [categoryId], references: [id])
  products      Product[]
  createdAt     DateTime  @default(now())
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  updatedAt DateTime   @updatedAt
  lastAbandonedEmailSentAt DateTime?
}

model CartItem {
  id              String   @id @default(cuid())
  cartId          String
  cart            Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId       Int
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId       String?
  variant         ProductVariant? @relation(fields: [variantId], references: [id])
  quantity        Int
  selectedOptions Json?
}

model NewsletterSubscriber {
  id          String   @id @default(cuid())
  email       String   @unique
  createdAt   DateTime @default(now())
  isActive    Boolean  @default(true)
}

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  icon      String?
  color     String?
  description String? @db.Text
  coupons     Coupon[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Banner {
  id          String   @id @default(cuid())
  title       String
  subtitle    String?
  image       String
  link        String?
  location    String   @default("HOME")
  linkType    String   @default("BUTTON")
  showButton  Boolean  @default(true)
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model BlogPost {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  content   String   @db.Text
  excerpt   String?  @db.Text
  image     String?
  author    String
  published Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Setting {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

model SettingAudit {
  id        String   @id @default(cuid())
  key       String
  oldValue  String?
  newValue  String
  author    String?  // email or userId
  ip        String?
  createdAt DateTime @default(now())

  @@index([key])
  @@index([author])
}
model InventoryLog {
  id          String   @id @default(cuid())
  productId   Int
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId   String?
  variant     ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  change      Int      // Positive for restock, negative for sale
  reason      String   // "ORDER_PLACED", "ORDER_CANCELLED", "MANUAL_ADJUSTMENT", "RESTOCK"
  referenceId String?  // Order ID or other reference
  createdAt   DateTime @default(now())
  userId      String?  // Who made the change (if manual)
}

model SearchLog {
  id        String   @id @default(cuid())
  query     String
  userId    String?
  resultsCount Int
  createdAt DateTime @default(now())
}

model WebhookEvent {
  id          String   @id @default(cuid())
  provider    String   // e.g., "stripe"
  eventId     String   @unique
  type        String
  payload     Json
  processed   Boolean  @default(false)
  processedAt DateTime?
  receivedAt  DateTime @default(now())
  retryCount   Int     @default(0)

  @@index([provider])
  @@index([processed])
}

model Brand {
  id          String   @id @default(cuid())
  name        String
  logo        String?  // URL to logo image
  isVisible   Boolean  @default(true)
  order       Int      @default(0)
  products    Product[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}


